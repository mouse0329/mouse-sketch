name: è‡ªå‹•é›£èª­åŒ–ï¼†å…¬é–‹ï¼ˆdev â†’ mainï¼‰

on:
  workflow_dispatch:
  push:
    branches:
      - main  # dev ãƒªãƒã‚¸ãƒˆãƒªã« push ã—ãŸã‚‰åæ˜ ã—ãŸã„å ´åˆã¯å¤‰æ›´å¯
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-from-dev:
    runs-on: ubuntu-latest

    steps:
      # ===== é–‹ç™ºãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ =====
      - name: ğŸ” mouse-sketch-dev ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ãƒãƒ¥ãƒ¼
        run: |
          if [ -z "${{ secrets.GH_TOKEN_PUBLIC }}" ]; then
            echo "âŒ GH_TOKEN_PUBLIC ãŒæœªè¨­å®šãƒãƒ¥ãƒ¼"
            exit 1
          fi

          rm -rf dev-repo
          git clone https://x-access-token:${{ secrets.GH_TOKEN_PUBLIC }}@github.com/mouse0329/mouse-sketch-dev.git dev-repo

      # ===== Node.js è¨­å®š =====
      - name: ğŸ§€ Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒãƒ¥ãƒ¼
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # ===== JSé›£èª­åŒ– =====
      - name: ğŸ§  script.js ã‚’é›£èª­åŒ–ãƒãƒ¥ãƒ¼
        run: |
          npm install -g javascript-obfuscator
          javascript-obfuscator dev-repo/script.js \
            --output script.js \
            --compact true \
            --self-defending true

      # ===== devå†…å®¹ã‚’ / ã«å±•é–‹ï¼ˆJSã¯ä¸Šæ›¸ãï¼‰ =====
      - name: ğŸ­ dev â†’ / ã«å±•é–‹ãƒãƒ¥ãƒ¼
        run: |
          rsync -av --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "script.js" \
            dev-repo/ ./

      # ===== commit & push =====
      - name: ğŸ›¡ï¸ commit & push ãƒãƒ¥ãƒ¼
        run: |
          git config user.name "GitHub Actions Mouse"
          git config user.email "mouse@github"

          git add .
          git commit -m "ğŸ§€ dev ã‹ã‚‰è‡ªå‹•å±•é–‹ï¼†JSé›£èª­åŒ–ãƒãƒ¥ãƒ¼" || echo "No changes"

          git push
