<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>ネズミスケッチ</title>
    <link rel="stylesheet" href="style.css">
    <script src="lib/"></script>
    <script src="lib/"></script>
    <script src="lib/"></script>
    <script src="lib/"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="nezumi-drawing_icon.webp" type="image/x-icon">
</head>

<body>
    <header id="header">
        <h1><img src="nezumi-drawing_icon.webp" alt="ネズミスケッチアイコン" class="header-icon" width="32">ネズミスケッチ</h1>
        <div id="project-controls-header">
            <button onclick="addProject()">画像追加</button>
            <span id="projectCount"></span>
            <div id="projectList"></div>
        </div>
        <button id="menu-toggle-btn" onclick="toggleSideMenu()" aria-label="メニューを開く" style="display:none;">☰</button>
    </header>
    <div id="main-container">
        <div id="sidebar" class="sidepanel">
            <button id="menu-toggle-btn-close" class="menu-close" onclick="toggleSideMenu()" style="display:none;"
                aria-label="メニューを閉じる">×</button>
            <div class="sidepanel-scroll">
                <section class="section collapsible" id="frame-section">
                    <div class="section-header" onclick="toggleSection('frame-section')">
                        <h2>フレーム</h2>
                        <span class="toggle-btn" id="toggle-frame-section">▼</span>
                    </div>
                    <div class="section-content" id="frame-section-content">
                        <div id="frame-controls">
                            <button onclick="addFrame()">フレーム追加</button>
                            <span id="frameCount"></span>
                            <button onclick="playAnimation()">▶再生</button>
                            <button onclick="stopAnimation()">■停止</button>
                        </div>
                        <div id="frameList"></div>
                    </div>
                </section>
                <section class="section collapsible" id="layer-section">
                    <div class="section-header" onclick="toggleSection('layer-section')">
                        <h2>レイヤー</h2>
                        <span class="toggle-btn" id="toggle-layer-section">▼</span>
                    </div>
                    <div class="section-content" id="layer-section-content">
                        <div id="layer-controls">
                            <button onclick="addLayer()">レイヤー追加</button>
                            <span id="layerCount"></span>
                        </div>
                        <div id="layerList"></div>
                    </div>
                </section>
                <section class="section collapsible" id="tool-section">
                    <div class="section-header" onclick="toggleSection('tool-section')">
                        <h2>ツール・操作</h2>
                        <span class="toggle-btn" id="toggle-tool-section">▼</span>
                    </div>
                    <div class="section-content" id="tool-section-content">
                        <div id="controls">
                            <label>キャンバスサイズ:
                                <input type="number" id="canvasWidth" value="16" min="1"> x
                                <input type="number" id="canvasHeight" value="16" min="1">
                                <button onclick="initCanvas()">作成</button>
                            </label>
                            <div class="tool-group">
                                <button class="tool-btn active" data-tool="pen" onclick="setTool('pen')">ペン</button>
                                <button class="tool-btn" data-tool="fill" onclick="setTool('fill')">塗りつぶし</button>
                                <button class="tool-btn" data-tool="eraser" onclick="setTool('eraser')">消しゴム</button>
                                <input type="color" id="colorPicker" value="#ff0000" title="色を選択">
                                <!-- ペン太さ選択 -->
                                <label style="margin-left:8px;">
                                    太さ:
                                    <select id="penSize" onchange="setPenSize(this.value)">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                    </select>
                                </label>
                                <!-- ペンモード切替 -->
                                <label style="margin-left:8px;">
                                    <select id="penMode" onchange="setPenMode(this.value)">
                                        <option value="square">四角ペン</option>
                                        <option value="circle">丸ペン</option>
                                    </select>
                                </label>
                            </div>
                            <div class="action-group">
                                <button onclick="undo()">戻す</button>
                                <button onclick="redo()">戻すを戻す</button>
                            </div>
                            <div class="export-group">
                                <button onclick="exportImage('png')">PNG</button>
                                <button onclick="exportImage('jpg')">JPG</button>
                                <button onclick="exportImage('webp')">WEBP</button>
                                <button onclick="exportGif()">GIF</button>
                                <button onclick="exportApng()">APNG</button>
                                <button onclick="saveProjectFile()">保存</button>
                                <label class="file-load-label">
                                    <input type="file" id="loadProjectFile" accept=".msketch,application/json"
                                        style="display:none" onchange="loadProjectFile(event)">
                                    <span class="file-load-btn">開く</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        <div id="main-panel">
            <section class="section">
                <h2>キャンバス</h2>
                <div id="canvas-container" style="overflow:auto; max-width:100vw; max-height:70vh;">
                    <canvas id="canvas" style="display:block; max-width:none; max-height:none;"></canvas>
                </div>
            </section>
            <!-- パレット追加: -->
            <div id="color-palette" class="palette-bar">
                <!-- パレット色はscript.jsで生成 -->
            </div>
        </div>
    </div>
    <script src="script.js"></script>
    <script>
        // 開閉UI
        function toggleSection(id) {
            const section = document.getElementById(id);
            const content = section.querySelector('.section-content');
            const btn = section.querySelector('.toggle-btn');
            if (content.style.display === "none") {
                content.style.display = "";
                btn.textContent = "▼";
            } else {
                content.style.display = "none";
                btn.textContent = "▲";
            }
        }
        // 初期状態: 開く
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll('.section.collapsible .section-content').forEach(el => el.style.display = "");
            document.querySelectorAll('.section.collapsible .toggle-btn').forEach(el => el.textContent = "▼");
        });
        // プロジェクトリストをヘッダーに移動
        window.addEventListener("DOMContentLoaded", () => {
            const headerList = document.getElementById("projectList");
            const oldList = document.querySelector("#project-controls #projectList");
            if (oldList && headerList && oldList !== headerList) {
                headerList.innerHTML = oldList.innerHTML;
            }
        });
        // サイドパネル開閉
        function toggleSideMenu(forceOpen) {
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('main-container');
            const openBtn = document.getElementById('menu-toggle-btn');
            const closeBtn = document.getElementById('menu-toggle-btn-close');
            const isOpen = sidebar.classList.contains('open');
            let willOpen = typeof forceOpen === "boolean" ? forceOpen : !isOpen;
            if (willOpen) {
                sidebar.classList.add('open');
                mainContainer.classList.add('sidebar-open');
                document.body.style.overflow = "hidden";
                document.body.style.touchAction = "none";
                if (window.innerWidth <= 900) {
                    closeBtn.style.display = "block";
                    openBtn.style.display = "none";
                }
            } else {
                sidebar.classList.remove('open');
                mainContainer.classList.remove('sidebar-open');
                document.body.style.overflow = "";
                document.body.style.touchAction = "";
                if (window.innerWidth <= 900) {
                    closeBtn.style.display = "none";
                    openBtn.style.display = "block";
                }
            }
        }
        // 画面幅変更時に自動で閉じる・開けるボタン表示
        function updateMenuBtnDisplay() {
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('main-container');
            const openBtn = document.getElementById('menu-toggle-btn');
            const closeBtn = document.getElementById('menu-toggle-btn-close');
            if (window.innerWidth > 900) {
                sidebar.classList.remove('open');
                mainContainer.classList.remove('sidebar-open');
                closeBtn.style.display = "none";
                openBtn.style.display = "none";
                document.body.style.overflow = "";
                document.body.style.touchAction = "";
            } else {
                if (sidebar.classList.contains('open')) {
                    closeBtn.style.display = "block";
                    openBtn.style.display = "none";
                } else {
                    closeBtn.style.display = "none";
                    openBtn.style.display = "block";
                }
            }
        }
        window.addEventListener('resize', updateMenuBtnDisplay);
        document.addEventListener('DOMContentLoaded', updateMenuBtnDisplay);

        // サイドパネル外クリックで閉じる（モバイルのみ）
        document.addEventListener('click', function (e) {
            if (window.innerWidth > 900) return;
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('main-container');
            const btn = document.getElementById('menu-toggle-btn');
            const closeBtn = document.getElementById('menu-toggle-btn-close');
            if (!sidebar.contains(e.target) && e.target !== btn && e.target !== closeBtn) {
                sidebar.classList.remove('open');
                mainContainer.classList.remove('sidebar-open');
                closeBtn.style.display = "none";
                btn.style.display = "block";
                document.body.style.overflow = "";
                document.body.style.touchAction = "";
            }
        });
    </script>
</body>

</html>